<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drone Dispatch System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
    }

    header {
      background: #2d3748;
      color: #fff;
      padding: 1.5rem 0;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .hero {
      max-width: 1200px;
      margin: 2rem auto 0 auto;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.07);
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      padding: 1rem;
      flex-direction: column;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 16px;
    }

    #eta {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #2563eb;
      font-weight: bold;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      padding: 0 1rem;
    }

    .info-box {
      flex: 1 1 350px;
      background: #fff;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.07);
      min-width: 280px;
    }

    h1,
    h2,
    h3 {
      margin-top: 0;
    }

    h2 {
      color: #2563eb;
    }

    h3 {
      color: #16a34a;
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 1rem;
      }

      .hero {
        height: auto;
        padding: 0.5rem;
      }

      #map {
        height: 220px;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Drone Dispatch System</h1>
  </header>

  <section class="hero">
    <div id="map"></div>
    <div id="eta">Calculating ETA...</div>
  </section>

  <main class="container">
    <section class="info-box">
      <h2>Delivery Information</h2>
      {% if data %}
      <ul>
        <li>
          <strong>Vaccine Type:</strong> {{ data.vaccine_type }}<br>
          <strong>Latitude:</strong> {{ data.latitude }}<br>
          <strong>Longitude:</strong> {{ data.longitude }}<br>
          <strong>Distance : </strong>{{ data.distance }} km<br>
        </li>
      </ul>
      {% else %}
      <ul>
        <li>No delivery information available.</li>
      </ul>
      {% endif %}
    </section>
    <section class="info-box">
      <h3>Main Drone Script</h3>
      <p>Drone automation script details will go here...</p>
    </section>
  </main>
</body>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Home station coordinates
  const homeLat = 30.3529, homeLng = 76.3637;

  // Target coordinates from Flask template (fallback = home)
  const targetLat = {{ data.latitude|default(homeLat) }},
        targetLng = {{ data.longitude|default(homeLng) }};

  // Initialize map
  const map = L.map('map').setView([homeLat, homeLng], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Markers
  L.marker([homeLat, homeLng]).addTo(map).bindPopup("Home Station").openPopup();
  L.marker([targetLat, targetLng]).addTo(map).bindPopup("Delivery Location");

  // Path
  const path = [[homeLat, homeLng], [targetLat, targetLng]];
  L.polyline(path, { color: 'red', weight: 3, opacity: 0.8 }).addTo(map);

  // Distance & ETA
  const distanceMeters = map.distance([homeLat, homeLng], [targetLat, targetLng]);
  const distanceKm = distanceMeters / 1000;
  const speedKmh = 100;
  const etaHours = distanceKm / speedKmh;
  const durationMs = etaHours * 3600 * 1000;

  // Drone icon
  const droneIcon = L.icon({
    iconUrl: "static/icons/drone.ico",
    iconSize: [40, 40],
    iconAnchor: [20, 20],
  });

  const droneMarker = L.marker([homeLat, homeLng], { icon: droneIcon }).addTo(map);

  // Animation
  let startTime = null;
  function animateDrone(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const progress = Math.min(elapsed / durationMs, 1);

    // Interpolate position
    const lat = homeLat + (targetLat - homeLat) * progress;
    const lng = homeLng + (targetLng - homeLng) * progress;

    droneMarker.setLatLng([lat, lng]);

    // Update ETA countdown
    const remainingMs = durationMs - elapsed;
    if (remainingMs > 0) {
      const minutes = Math.floor(remainingMs / 60000);
      const seconds = Math.floor((remainingMs % 60000) / 1000);
      document.getElementById("eta").innerText =
        `ETA: ${minutes}m ${seconds}s (Speed: ${speedKmh} km/h, Distance: ${distanceKm.toFixed(2)} km)`;
    } else {
      document.getElementById("eta").innerText = "Drone Arrived!";
    }

    if (progress < 1) {
      requestAnimationFrame(animateDrone);
    } else {
      droneMarker.bindPopup("Drone Arrived!").openPopup();
    }
  }

  requestAnimationFrame(animateDrone);

  // Fit map to bounds between home and target
  const bounds = L.latLngBounds([homeLat, homeLng], [targetLat, targetLng]);
  map.fitBounds(bounds.pad(0.2)); // Add some padding for better view

  // Keep drone always in center during animation
  function animateDroneWithCenter(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const progress = Math.min(elapsed / durationMs, 1);

    // Interpolate position
    const lat = homeLat + (targetLat - homeLat) * progress;
    const lng = homeLng + (targetLng - homeLng) * progress;

    droneMarker.setLatLng([lat, lng]);
    map.setView([lat, lng], map.getZoom(), { animate: false });

    // Update ETA countdown
    const remainingMs = durationMs - elapsed;
    if (remainingMs > 0) {
      const minutes = Math.floor(remainingMs / 60000);
      const seconds = Math.floor((remainingMs % 60000) / 1000);
      document.getElementById("eta").innerText =
        `ETA: ${minutes}m ${seconds}s (Speed: ${speedKmh} km/h, Distance: ${distanceKm.toFixed(2)} km)`;
    } else {
      document.getElementById("eta").innerText = "Drone Arrived!";
    }

    if (progress < 1) {
      requestAnimationFrame(animateDroneWithCenter);
    } else {
      droneMarker.bindPopup("Drone Arrived!").openPopup();
    }
  }

  // Start animation with drone always centered
  requestAnimationFrame(animateDroneWithCenter);
</script>

</html>
